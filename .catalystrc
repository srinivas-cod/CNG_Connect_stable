<!DOCTYPE html>
<html>
<head>
  <title>CNG Connect (Chennai)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    #nearestBtn {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: #28a745;
      color: white;
      font-weight: bold;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #nearestBtn:hover {
      background: #218838;
    }
    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 10px;
      border: 1px solid #999;
      border-radius: 6px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #legend div {
      margin: 4px 0;
    }
    #legend img {
      vertical-align: middle;
      margin-right: 5px;
    }
  </style>
</head>

<body>
  <button id="nearestBtn">Go to Nearest Station</button>
  <div id="map"></div>

  <div id="legend">
    <h4>Legend</h4>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/green-dot.png" width="24"> Available</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/orange-dot.png" width="24"> 15 min Queue</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" width="24"> Not Available</div>
    <div><img src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png" width="24"> You</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    let stations = [];  // Will be filled from backend

    let map = L.map("map").setView([13.0418, 80.2337], 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const icons = {
      available: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
      queue: "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
      not: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
    };

    // Fetch data from backend
    async function loadStations() {
      try {
        const response = await fetch("http://localhost:8080/stations");
        stations = await response.json();
        console.log("Fetched stations:", stations);
        addStationsToMap();
      } catch (err) {
        console.error("Error fetching backend data:", err);
      }
    }

    function addStationsToMap() {
      stations.forEach(st => {
        const marker = L.marker([st.latitude, st.longitude], {
          icon: L.icon({
            iconUrl: icons[st.status],
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(map);

        marker.bindTooltip(`${st.name}<br>Status: ${
          st.status === "available" ? "Available" :
          st.status === "queue" ? "15 min Queue" : "Not Available"
        }`);
      });
    }

    let userMarker = null;
    let routingControl = null;

    // User location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = [pos.coords.latitude, pos.coords.longitude];
        userMarker = L.marker(loc, {
          icon: L.icon({
            iconUrl: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(map).bindPopup("You are here").openPopup();

        map.setView(loc, 13);
      });
    }

    // Find nearest station
    document.getElementById("nearestBtn").addEventListener("click", () => {
      if (!userMarker) {
        alert("Location not available yet.");
        return;
      }

      const userLoc = userMarker.getLatLng();
      let nearest = null;
      let minDist = Infinity;

      stations.forEach(st => {
        const dist = map.distance(userLoc, [st.latitude, st.longitude]);
        if (dist < minDist) {
          minDist = dist;
          nearest = st;
        }
      });

      if (nearest) {
        if (routingControl) map.removeControl(routingControl);

        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(userLoc.lat, userLoc.lng),
            L.latLng(nearest.latitude, nearest.longitude)
          ],
          routeWhileDragging: false,
          createMarker: () => null
        }).addTo(map);
      }
    });

    // Load data from backend on page load
    loadStations();
  </script>
</body>
</html>